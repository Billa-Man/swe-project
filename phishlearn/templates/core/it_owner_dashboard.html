{% extends "base.html" %}

{% block title %}IT Owner Dashboard{% endblock %}

{% block extra_css %}
<style>
    .navbar {
        background-color: #1e293b !important;
        padding: 1rem 2rem;
    }

    .navbar-brand {
        color: white !important;
        font-size: 1.25rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .navbar-brand i {
        font-size: 1.25rem;
        color: white !important;
    }

    .nav-right {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .profile-circle {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background-color: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dashboard {
        padding: 2rem;
        background-color: #f8fafc;
        min-height: calc(100vh - 64px);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .department-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .department-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        background-color: #e0e7ff;
        color: #4338ca;
        border-radius: 1rem;
        font-size: 0.875rem;
    }

    .add-more {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        color: #4338ca;
        background-color: #f5f3ff;
        border-radius: 1rem;
        font-size: 0.875rem;
        text-decoration: none;
        gap: 0.25rem;
    }

    .btn-primary {
        display: inline-flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .btn-primary:hover {
        background-color: #2563eb;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.875rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
    }

    .open-rate { color: #3b82f6; }
    .click-rate { color: #10b981; }
    .bounce-rate { color: #ef4444; }

    .campaign-date {
        text-align: center;
        color: #64748b;
        font-size: 0.875rem;
        margin-top: 1rem;
    }

    .analytics-table {
        width: 100%;
        border-collapse: collapse;
    }

    .analytics-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        color: #64748b;
        font-weight: 500;
        font-size: 0.875rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .analytics-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-avatar {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background-color: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .user-details {
        font-size: 0.875rem;
    }

    .user-email {
        color: #64748b;
        font-size: 0.75rem;
    }

    .progress-bar {
        width: 100px;
        height: 0.5rem;
        background-color: #e2e8f0;
        border-radius: 0.25rem;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background-color: #10b981;
        border-radius: 0.25rem;
    }
</style>
{% endblock %}

{% block navbar %}
<nav class="navbar">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="/">
            <i class="fas fa-shield-alt me-2" style="color: white !important;"></i>
            PhishLearn IT Owner
        </a>
        <div class="nav-right">
            <i class="fas fa-bell text-white"></i>
            <div class="profile-circle">
                <img src="{{ user.profile_image.url|default:'/static/images/default-avatar.png' }}" alt="Profile" class="w-100 h-100 rounded-circle">
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="container">
        <div class="section-title">Email Campaigns</div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Campaign Name</label>
                    <input type="text" class="form-control" placeholder="Q1 Awareness Campaign" value="Q1 Awareness Campaign">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Template</label>
                    <select class="form-control">
                        <option>Password Reset</option>
                        <option>Package Delivery</option>
                        <option>IT Support</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Target Departments</label>
            <div class="department-tags">
                <span class="department-tag">Marketing</span>
                <span class="department-tag">Sales</span>
                <a href="#" class="add-more">
                    <i class="fas fa-plus"></i>
                    Add More
                </a>
            </div>
        </div>

        <div class="d-flex justify-content-end mb-4">
            <button class="btn btn-primary">Schedule Campaign</button>
        </div>

        <div class="d-flex justify-content-end mb-4">
          <a href="{% url 'reset_api_key' %}" class="btn btn-danger">
            Reset API Key
          </a>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="section-title">User Analytics</div>
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Department</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">SW</div>
                                    <div class="user-details">
                                        <div>Sarah Wilson</div>
                                        <div class="user-email">sarah@company.com</div>
                                    </div>
                                </div>
                            </td>
                            <td>Marketing</td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 85%"></div>
                                    </div>
                                    <span>85%</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col-md-6">
                <div class="section-title">Email Statistics</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value open-rate">24%</div>
                        <div class="stat-label">Open Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value click-rate">12%</div>
                        <div class="stat-label">Click Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value bounce-rate">2%</div>
                        <div class="stat-label">Bounce Rate</div>
                    </div>
                </div>
                <div class="campaign-date">
                    Last Campaign Performance â€¢ March 1-7, 2025
                </div>
            </div>
        </div>
    </div>   
    <div class="card mt-5 shadow-sm border-0 rounded-lg">
        <div class="card-header bg-primary text-white text-center py-3">
          <h3 class="mb-0"><i class="bi bi-journal-check me-2"></i>Assign a Quiz to Employees</h3>
        </div>
        <div class="card-body p-4">
          <form method="POST" action="{% url 'assign_quiz_to_users' %}">
            {% csrf_token %}
            
            <!-- Quiz Selection with Search -->
            <div class="mb-4">
              <label for="quizSelect" class="form-label fw-semibold">
                <i class="bi bi-book me-2"></i>Select Quiz
              </label>
              <div class="input-group">
                <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                <input type="text" id="quizSearchInput" class="form-control" placeholder="Search quizzes..." aria-label="Search quizzes">
              </div>
              <select id="quizSelect" name="quiz_id" class="form-select mt-2 shadow-sm" required aria-describedby="quizHelp">
                <option value="" disabled selected>-- Choose a quiz --</option>
                {% for quiz in quizzes %}
                  <option value="{{ quiz.id }}" data-course="{{ quiz.course.title }}">{{ quiz.title }} ({{ quiz.course.title }})</option>
                {% endfor %}
              </select>
              <small id="quizHelp" class="form-text text-muted mt-1">Choose the quiz you want to assign to employees.</small>
            </div>
            
            <!-- Two-Column Employee Selection -->
            <div class="mb-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-people me-2"></i>Select Employees
              </label>
              
              <div class="input-group mb-2">
                <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                <input type="text" id="employeeSearchInput" class="form-control" placeholder="Search employees..." aria-label="Search employees">
              </div>
              
              <div class="row">
                <!-- Unselected Employees Column -->
                <div class="col-md-6 mb-2 mb-md-0">
                  <div class="card h-100">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                      <h6 class="mb-0">Available Employees</h6>
                      <span class="badge bg-secondary" id="unselectedCount">0</span>
                    </div>
                    <div class="card-body p-0">
                      <div class="list-group list-group-flush unselected-employees" style="height: 250px; overflow-y: auto;">
                        {% for employee in employees %}
                        <div class="list-group-item list-group-item-action employee-item d-flex justify-content-between align-items-center" 
                             data-id="{{ employee.id }}" data-name="{{ employee.username }}" data-department="{{ employee.department }}">
                          <div>
                            <span class="employee-name">{{ employee.username }}</span>
                            <small class="d-block text-muted">{{ employee.department }}</small>
                          </div>
                          <button type="button" class="btn btn-sm btn-outline-primary select-btn">
                            <i class="bi bi-arrow-right"></i>
                          </button>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                    <div class="card-footer bg-light py-2">
                      <button type="button" class="btn btn-sm btn-outline-primary w-100" id="selectAllBtn">
                        Select All <i class="bi bi-arrow-right"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Selected Employees Column -->
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                      <h6 class="mb-0">Selected Employees</h6>
                      <span class="badge bg-success" id="selectedCount">0</span>
                    </div>
                    <div class="card-body p-0">
                      <div class="list-group list-group-flush selected-employees" style="height: 250px; overflow-y: auto;">
                        <!-- Selected employees will appear here via JavaScript -->
                      </div>
                    </div>
                    <div class="card-footer bg-light py-2">
                      <button type="button" class="btn btn-sm btn-outline-danger w-100" id="deselectAllBtn">
                        <i class="bi bi-arrow-left"></i> Remove All
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Hidden input to store selected employee IDs -->
              <div id="selectedEmployeeInputs"></div>
              
              <small id="employeeHelp" class="form-text text-muted mt-2">Select one or more employees to assign this quiz.</small>
            </div>
            
            <!-- Due Date with Calendar Widget -->
            <div class="mb-4">
              <label for="dueDate" class="form-label fw-semibold">
                <i class="bi bi-calendar-event me-2"></i>Due Date
              </label>
              <div class="input-group">
                <input type="date" id="dueDate" name="due_date" class="form-control shadow-sm" aria-describedby="dueDateHelp">
                <button class="btn btn-outline-secondary" type="button" id="set2Weeks">+2 Weeks</button>
                <button class="btn btn-outline-secondary" type="button" id="set1Month">+1 Month</button>
              </div>
              <small id="dueDateHelp" class="form-text text-muted mt-1">Leave blank to auto-set a due date 14 days from today.</small>
            </div>
            
            <!-- Notification Options -->
            <div class="mb-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-bell me-2"></i>Notification Options
              </label>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="sendEmailNotif" name="send_email" checked>
                <label class="form-check-label" for="sendEmailNotif">
                  Send email notification to employees
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="sendReminders" name="send_reminders" checked>
                <label class="form-check-label" for="sendReminders">
                  Send reminders before due date
                </label>
              </div>
            </div>
            
            <!-- Submit & Cancel Buttons -->
            <div class="d-flex justify-content-between align-items-center mt-4">
              <button type="button" class="btn btn-outline-secondary px-4" id="cancelBtn">
                <i class="bi bi-x-circle me-2"></i>Cancel
              </button>
              <button type="submit" class="btn btn-success px-4 py-2 shadow-sm d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-check-circle"></i>
                <span>Assign Quiz</span>
              </button>
            </div>
          </form>
        </div>
    </div>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const unselectedContainer = document.querySelector('.unselected-employees');
          const selectedContainer = document.querySelector('.selected-employees');
          const selectedEmployeeInputs = document.getElementById('selectedEmployeeInputs');
          const selectedCount = document.getElementById('selectedCount');
          const unselectedCount = document.getElementById('unselectedCount');
          
          // Initialize counters
          updateCounters();
          
          // Quiz search functionality
          document.getElementById('quizSearchInput').addEventListener('input', function() {
            const searchValue = this.value.toLowerCase();
            const options = document.querySelectorAll('#quizSelect option:not([disabled])');
            
            options.forEach(option => {
              const text = option.textContent.toLowerCase();
              if (text.includes(searchValue)) {
                option.style.display = '';
              } else {
                option.style.display = 'none';
              }
            });
          });
          
          // Employee search functionality
          document.getElementById('employeeSearchInput').addEventListener('input', function() {
            const searchValue = this.value.toLowerCase();
            const employees = document.querySelectorAll('.employee-item');
            
            employees.forEach(item => {
              const name = item.getAttribute('data-name').toLowerCase();
              const department = item.getAttribute('data-department').toLowerCase();
              
              if (name.includes(searchValue) || department.includes(searchValue)) {
                item.style.display = '';
              } else {
                item.style.display = 'none';
              }
            });
          });
          
          // Handle select/deselect individual employee
          unselectedContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('select-btn') || e.target.parentElement.classList.contains('select-btn')) {
              const employeeItem = e.target.closest('.employee-item');
              if (employeeItem) {
                moveToSelected(employeeItem);
              }
            }
          });
          
          selectedContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('deselect-btn') || e.target.parentElement.classList.contains('deselect-btn')) {
              const employeeItem = e.target.closest('.employee-item');
              if (employeeItem) {
                moveToUnselected(employeeItem);
              }
            }
          });
          
          // Select All button
          document.getElementById('selectAllBtn').addEventListener('click', function() {
            const visibleEmployees = [...unselectedContainer.querySelectorAll('.employee-item')]
              .filter(item => item.style.display !== 'none');
            
            visibleEmployees.forEach(employee => {
              moveToSelected(employee);
            });
          });
          
          // Deselect All button
          document.getElementById('deselectAllBtn').addEventListener('click', function() {
            const selectedEmployees = [...selectedContainer.querySelectorAll('.employee-item')];
            
            selectedEmployees.forEach(employee => {
              moveToUnselected(employee);
            });
          });
          
          // Move employee to selected column
          function moveToSelected(employeeItem) {
            const employeeId = employeeItem.getAttribute('data-id');
            const employeeName = employeeItem.getAttribute('data-name');
            const employeeDept = employeeItem.getAttribute('data-department');
            
            // Clone the employee item for the selected container
            const clonedItem = document.createElement('div');
            clonedItem.className = 'list-group-item list-group-item-action employee-item d-flex justify-content-between align-items-center';
            clonedItem.setAttribute('data-id', employeeId);
            clonedItem.setAttribute('data-name', employeeName);
            clonedItem.setAttribute('data-department', employeeDept);
            
            clonedItem.innerHTML = `
              <div>
                <span class="employee-name">${employeeName}</span>
                <small class="d-block text-muted">${employeeDept}</small>
              </div>
              <button type="button" class="btn btn-sm btn-outline-danger deselect-btn">
                <i class="bi bi-arrow-left"></i>
              </button>
            `;
            
            // Add hidden input for form submission
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'user_ids';
            hiddenInput.value = employeeId;
            hiddenInput.id = `employee-input-${employeeId}`;
            selectedEmployeeInputs.appendChild(hiddenInput);
            
            // Remove from unselected and add to selected
            employeeItem.remove();
            selectedContainer.appendChild(clonedItem);
            
            updateCounters();
          }
          
          // Move employee to unselected column
          function moveToUnselected(employeeItem) {
            const employeeId = employeeItem.getAttribute('data-id');
            const employeeName = employeeItem.getAttribute('data-name');
            const employeeDept = employeeItem.getAttribute('data-department');
            
            // Clone the employee item for the unselected container
            const clonedItem = document.createElement('div');
            clonedItem.className = 'list-group-item list-group-item-action employee-item d-flex justify-content-between align-items-center';
            clonedItem.setAttribute('data-id', employeeId);
            clonedItem.setAttribute('data-name', employeeName);
            clonedItem.setAttribute('data-department', employeeDept);
            
            clonedItem.innerHTML = `
              <div>
                <span class="employee-name">${employeeName}</span>
                <small class="d-block text-muted">${employeeDept}</small>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary select-btn">
                <i class="bi bi-arrow-right"></i>
              </button>
            `;
            
            // Remove hidden input
            const hiddenInput = document.getElementById(`employee-input-${employeeId}`);
            if (hiddenInput) {
              hiddenInput.remove();
            }
            
            // Remove from selected and add to unselected
            employeeItem.remove();
            unselectedContainer.appendChild(clonedItem);
            
            updateCounters();
          }
          
          // Update employee counters
          function updateCounters() {
            const unselectedItems = unselectedContainer.querySelectorAll('.employee-item').length;
            const selectedItems = selectedContainer.querySelectorAll('.employee-item').length;
            
            unselectedCount.textContent = unselectedItems;
            selectedCount.textContent = selectedItems;
          }
          
          // Quick due date setters
          document.getElementById('set2Weeks').addEventListener('click', function() {
            const today = new Date();
            const twoWeeksLater = new Date(today.setDate(today.getDate() + 14));
            document.getElementById('dueDate').valueAsDate = twoWeeksLater;
          });
          
          document.getElementById('set1Month').addEventListener('click', function() {
            const today = new Date();
            const oneMonthLater = new Date(today.setMonth(today.getMonth() + 1));
            document.getElementById('dueDate').valueAsDate = oneMonthLater;
          });
          
          // Cancel button
          document.getElementById('cancelBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
              window.history.back();
            }
          });
          
          // Form validation
          document.querySelector('form').addEventListener('submit', function(event) {
            const quizSelected = document.getElementById('quizSelect').value;
            const employeesSelected = selectedContainer.querySelectorAll('.employee-item').length;
            
            if (!quizSelected) {
              alert('Please select a quiz to assign.');
              event.preventDefault();
              return;
            }
            
            if (employeesSelected === 0) {
              alert('Please select at least one employee.');
              event.preventDefault();
              return;
            }
          });
        });
      </script>
</div>
{% endblock %} 