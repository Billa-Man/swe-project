{% extends "base.html" %}

{% block title %}Quizzes{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Quizzes</h2>
  <div class="card shadow-sm border-0 rounded-lg">
    <div class="card-header bg-primary text-white text-center py-3">
      <h3 class="mb-0"><i class="bi bi-journal-check me-2"></i>Assign a Quiz to Employees</h3>
    </div>
    <div class="card-body p-4">
      <form method="POST" action="{% url 'assign_quiz_to_users' %}">
        {% csrf_token %}
        <!-- Quiz Selection with Search -->
        <div class="mb-4">
          <label for="quizSelect" class="form-label fw-semibold">
            <i class="bi bi-book me-2"></i>Select Quiz
          </label>
          <div class="input-group">
            <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
            <input type="text" id="quizSearchInput" class="form-control" placeholder="Search quizzes..." aria-label="Search quizzes">
          </div>
          <select id="quizSelect" name="quiz_id" class="form-select mt-2 shadow-sm" required aria-describedby="quizHelp">
            <option value="" disabled selected>-- Choose a quiz --</option>
            {% for quiz in quizzes %}
              <option value="{{ quiz.id }}" data-course="{{ quiz.course.title }}">{{ quiz.title }} ({{ quiz.course.title }})</option>
            {% endfor %}
          </select>
          <small id="quizHelp" class="form-text text-muted mt-1">Choose the quiz you want to assign to employees.</small>
        </div>
        <!-- Two-Column Employee Selection -->
        <div class="mb-4">
          <label class="form-label fw-semibold">
            <i class="bi bi-people me-2"></i>Select Employees
          </label>
          <div class="input-group mb-2">
            <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
            <input type="text" id="employeeSearchInput" class="form-control" placeholder="Search employees..." aria-label="Search employees">
          </div>
          <div class="row">
            <!-- Unselected Employees Column -->
            <div class="col-md-6 mb-2 mb-md-0">
              <div class="card h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                  <h6 class="mb-0">Available Employees</h6>
                  <span class="badge bg-secondary" id="unselectedCount">0</span>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush unselected-employees" style="height: 250px; overflow-y: auto;">
                    {% for employee in employees %}
                    <div class="list-group-item list-group-item-action employee-item d-flex justify-content-between align-items-center" 
                         data-id="{{ employee.id }}" data-name="{{ employee.username }}" data-department="{{ employee.department }}">
                      <div>
                        <span class="employee-name">{{ employee.username }}</span>
                        <small class="d-block text-muted">{{ employee.department }}</small>
                      </div>
                      <button type="button" class="btn btn-sm btn-outline-primary select-btn">
                        <i class="bi bi-arrow-right"></i>
                      </button>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                <div class="card-footer bg-light py-2">
                  <button type="button" class="btn btn-sm btn-outline-primary w-100" id="selectAllBtn">
                    Select All <i class="bi bi-arrow-right"></i>
                  </button>
                </div>
              </div>
            </div>
            <!-- Selected Employees Column -->
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                  <h6 class="mb-0">Selected Employees</h6>
                  <span class="badge bg-success" id="selectedCount">0</span>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush selected-employees" style="height: 250px; overflow-y: auto;">
                    <!-- Selected employees will appear here via JavaScript -->
                  </div>
                </div>
                <div class="card-footer bg-light py-2">
                  <button type="button" class="btn btn-sm btn-outline-danger w-100" id="deselectAllBtn">
                    <i class="bi bi-arrow-left"></i> Remove All
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Hidden input to store selected employee IDs -->
          <div id="selectedEmployeeInputs"></div>
          <small id="employeeHelp" class="form-text text-muted mt-2">Select one or more employees to assign this quiz.</small>
        </div>
        <!-- Due Date with Calendar Widget -->
        <div class="mb-4">
          <label for="dueDate" class="form-label fw-semibold">
            <i class="bi bi-calendar-event me-2"></i>Due Date
          </label>
          <div class="input-group">
            <input type="date" id="dueDate" name="due_date" class="form-control shadow-sm" aria-describedby="dueDateHelp">
            <button class="btn btn-outline-secondary" type="button" id="set2Weeks">+2 Weeks</button>
            <button class="btn btn-outline-secondary" type="button" id="set1Month">+1 Month</button>
          </div>
          <small id="dueDateHelp" class="form-text text-muted mt-1">Leave blank to auto-set a due date 14 days from today.</small>
        </div>
        <!-- Notification Options -->
        <div class="mb-4">
          <label class="form-label fw-semibold">
            <i class="bi bi-bell me-2"></i>Notification Options
          </label>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="sendEmailNotif" name="send_email" checked>
            <label class="form-check-label" for="sendEmailNotif">
              Send email notification to employees
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sendReminders" name="send_reminders" checked>
            <label class="form-check-label" for="sendReminders">
              Send reminders before due date
            </label>
          </div>
        </div>
        <!-- Submit & Cancel Buttons -->
        <div class="d-flex justify-content-between align-items-center mt-4">
          <button type="button" class="btn btn-outline-secondary px-4" id="cancelBtn">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </button>
          <button type="submit" class="btn btn-success px-4 py-2 shadow-sm d-flex align-items-center justify-content-center gap-2">
            <i class="bi bi-check-circle"></i>
            <span>Assign Quiz</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
// The same JavaScript as in the dashboard for employee/quiz selection and form validation
// ... (copy the script block from the dashboard template here) ...
document.addEventListener('DOMContentLoaded', function() {
  const unselectedContainer = document.querySelector('.unselected-employees');
  const selectedContainer = document.querySelector('.selected-employees');
  const selectedEmployeeInputs = document.getElementById('selectedEmployeeInputs');
  const selectedCount = document.getElementById('selectedCount');
  const unselectedCount = document.getElementById('unselectedCount');

  // Initialize counters
  updateCounters();

  // Quiz search functionality
  document.getElementById('quizSearchInput').addEventListener('input', function() {
    const searchValue = this.value.toLowerCase();
    const options = document.querySelectorAll('#quizSelect option:not([disabled])');
    options.forEach(option => {
      const text = option.textContent.toLowerCase();
      if (text.includes(searchValue)) {
        option.style.display = '';
      } else {
        option.style.display = 'none';
      }
    });
  });

  // Employee search functionality
  document.getElementById('employeeSearchInput').addEventListener('input', function() {
    const searchValue = this.value.toLowerCase();
    const employees = document.querySelectorAll('.employee-item');
    employees.forEach(item => {
      const name = item.getAttribute('data-name').toLowerCase();
      const department = item.getAttribute('data-department').toLowerCase();
      if (name.includes(searchValue) || department.includes(searchValue)) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    });
  });

  // Handle select/deselect individual employee
  unselectedContainer.addEventListener('click', function(e) {
    if (e.target.classList.contains('select-btn') || e.target.parentElement.classList.contains('select-btn')) {
      const employeeItem = e.target.closest('.employee-item');
      if (employeeItem) {
        moveToSelected(employeeItem);
      }
    }
  });

  selectedContainer.addEventListener('click', function(e) {
    if (e.target.classList.contains('deselect-btn') || e.target.parentElement.classList.contains('deselect-btn')) {
      const employeeItem = e.target.closest('.employee-item');
      if (employeeItem) {
        moveToUnselected(employeeItem);
      }
    }
  });

  // Select All button
  document.getElementById('selectAllBtn').addEventListener('click', function() {
    const visibleEmployees = [...unselectedContainer.querySelectorAll('.employee-item')]
      .filter(item => item.style.display !== 'none');
    visibleEmployees.forEach(employee => {
      moveToSelected(employee);
    });
  });

  // Deselect All button
  document.getElementById('deselectAllBtn').addEventListener('click', function() {
    const selectedEmployees = [...selectedContainer.querySelectorAll('.employee-item')];
    selectedEmployees.forEach(employee => {
      moveToUnselected(employee);
    });
  });

  // Move employee to selected column
  function moveToSelected(employeeItem) {
    const employeeId = employeeItem.getAttribute('data-id');
    const employeeName = employeeItem.getAttribute('data-name');
    const employeeDept = employeeItem.getAttribute('data-department');
    // Clone the employee item for the selected container
    const clonedItem = document.createElement('div');
    clonedItem.className = 'list-group-item list-group-item-action employee-item d-flex justify-content-between align-items-center';
    clonedItem.setAttribute('data-id', employeeId);
    clonedItem.setAttribute('data-name', employeeName);
    clonedItem.setAttribute('data-department', employeeDept);
    clonedItem.innerHTML = `
      <div>
        <span class="employee-name">${employeeName}</span>
        <small class="d-block text-muted">${employeeDept}</small>
      </div>
      <button type="button" class="btn btn-sm btn-outline-danger deselect-btn">
        <i class="bi bi-arrow-left"></i>
      </button>
    `;
    // Add hidden input for form submission
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'user_ids';
    hiddenInput.value = employeeId;
    hiddenInput.id = `employee-input-${employeeId}`;
    selectedEmployeeInputs.appendChild(hiddenInput);
    // Remove from unselected and add to selected
    employeeItem.remove();
    selectedContainer.appendChild(clonedItem);
    updateCounters();
  }

  // Move employee to unselected column
  function moveToUnselected(employeeItem) {
    const employeeId = employeeItem.getAttribute('data-id');
    const employeeName = employeeItem.getAttribute('data-name');
    const employeeDept = employeeItem.getAttribute('data-department');
    // Clone the employee item for the unselected container
    const clonedItem = document.createElement('div');
    clonedItem.className = 'list-group-item list-group-item-action employee-item d-flex justify-content-between align-items-center';
    clonedItem.setAttribute('data-id', employeeId);
    clonedItem.setAttribute('data-name', employeeName);
    clonedItem.setAttribute('data-department', employeeDept);
    clonedItem.innerHTML = `
      <div>
        <span class="employee-name">${employeeName}</span>
        <small class="d-block text-muted">${employeeDept}</small>
      </div>
      <button type="button" class="btn btn-sm btn-outline-primary select-btn">
        <i class="bi bi-arrow-right"></i>
      </button>
    `;
    // Remove hidden input
    const hiddenInput = document.getElementById(`employee-input-${employeeId}`);
    if (hiddenInput) {
      hiddenInput.remove();
    }
    // Remove from selected and add to unselected
    employeeItem.remove();
    unselectedContainer.appendChild(clonedItem);
    updateCounters();
  }

  // Update employee counters
  function updateCounters() {
    const unselectedItems = unselectedContainer.querySelectorAll('.employee-item').length;
    const selectedItems = selectedContainer.querySelectorAll('.employee-item').length;
    unselectedCount.textContent = unselectedItems;
    selectedCount.textContent = selectedItems;
  }

  // Quick due date setters
  document.getElementById('set2Weeks').addEventListener('click', function() {
    const today = new Date();
    const twoWeeksLater = new Date(today.setDate(today.getDate() + 14));
    document.getElementById('dueDate').valueAsDate = twoWeeksLater;
  });
  document.getElementById('set1Month').addEventListener('click', function() {
    const today = new Date();
    const oneMonthLater = new Date(today.setMonth(today.getMonth() + 1));
    document.getElementById('dueDate').valueAsDate = oneMonthLater;
  });
  // Cancel button
  document.getElementById('cancelBtn').addEventListener('click', function() {
    if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
      window.history.back();
    }
  });
  // Form validation
  document.querySelector('form').addEventListener('submit', function(event) {
    const quizSelected = document.getElementById('quizSelect').value;
    const employeesSelected = selectedContainer.querySelectorAll('.employee-item').length;
    if (!quizSelected) {
      alert('Please select a quiz to assign.');
      event.preventDefault();
      return;
    }
    if (employeesSelected === 0) {
      alert('Please select at least one employee.');
      event.preventDefault();
      return;
    }
  });
});
</script>
{% endblock %} 