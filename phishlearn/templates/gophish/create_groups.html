{% extends "base.html" %}

{% block title %}Create New Group{% endblock %}

{% block content %}
<div class="container">
  <div class="page-header">
    <h1 class="page-title">Create New Target Group</h1>
    <p class="page-description">Create a group of targets for your phishing campaigns. Groups allow you to organize and manage email recipients for different phishing exercises.</p>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-4">
      {% if error %}
        <div class="alert alert-danger mb-4">
          <i class="fas fa-exclamation-circle me-2"></i> {{ error }}
        </div>
      {% endif %}
      
      <form method="POST" action="{% url 'create_group' %}">
        {% csrf_token %}
        
        <div class="mb-3">
          <label for="name" class="form-label">Group Name</label>
          <input type="text" class="form-control" id="name" name="name" required>
          <div class="form-text">A descriptive name for this target group (e.g., "IT Department", "Executive Team").</div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Target Recipients</label>
          <div class="card">
            <div class="card-header bg-light">
              <div class="d-flex justify-content-between align-items-center">
                <span>Add Recipients</span>
                <button type="button" class="btn btn-sm btn-primary" id="addRecipientBtn">
                  <i class="fas fa-plus me-1"></i> Add
                </button>
              </div>
            </div>
            <div class="card-body p-3">
              <div id="recipients-container">
                <!-- Initial recipient row -->
                <div class="recipient-row mb-3 border-bottom pb-3">
                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label small">First Name</label>
                      <input type="text" class="form-control recipient-first-name" placeholder="John">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small">Last Name</label>
                      <input type="text" class="form-control recipient-last-name" placeholder="Doe">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small">Email (required)</label>
                      <input type="email" class="form-control recipient-email" placeholder="john.doe@example.com" required>
                    </div>
                    <div class="col-md-10 mt-2">
                      <label class="form-label small">Position/Department</label>
                      <input type="text" class="form-control recipient-position" placeholder="IT Manager">
                    </div>
                    <div class="col-md-2 mt-2 d-flex align-items-end">
                      <button type="button" class="btn btn-outline-danger remove-recipient-btn" style="width: 100%;" disabled>
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="text-center text-muted small mt-2" id="no-recipients" style="display: none;">
                No recipients added yet. Click the "Add" button to add recipients.
              </div>
            </div>
            <div class="card-footer bg-light">
              <div class="d-flex justify-content-between align-items-center">
                <span class="small text-muted">Total recipients: <span id="recipient-count">1</span></span>
                <button type="button" class="btn btn-sm btn-success" id="importCSVBtn">
                  <i class="fas fa-file-csv me-1"></i> Import from CSV
                </button>
              </div>
            </div>
          </div>
          <!-- Hidden input to store all recipients as JSON -->
          <input type="hidden" id="targets" name="targets" value="[]">
        </div>
        
        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'gophish_management' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Management
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Create Group
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- CSV Import Modal -->
  <div class="modal fade" id="csvImportModal" tabindex="-1" aria-labelledby="csvImportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="csvImportModalLabel">Import Recipients from CSV</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="csvFile" class="form-label">Select CSV File</label>
            <input class="form-control" type="file" id="csvFile" accept=".csv">
            <div class="form-text">
              CSV should have columns: email, first_name, last_name, position (email is required).
            </div>
          </div>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> The first row of your CSV should contain headers.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="importCSVConfirmBtn">Import</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const recipientsContainer = document.getElementById('recipients-container');
    const addRecipientBtn = document.getElementById('addRecipientBtn');
    const recipientCountEl = document.getElementById('recipient-count');
    const noRecipientsEl = document.getElementById('no-recipients');
    const targetsInput = document.getElementById('targets');
    const importCSVBtn = document.getElementById('importCSVBtn');
    const csvImportModal = new bootstrap.Modal(document.getElementById('csvImportModal'));
    const importCSVConfirmBtn = document.getElementById('importCSVConfirmBtn');
    
    // Initialize targets as empty array
    let targets = [];
    updateTargetsInput();
    
    // Add a new recipient row
    addRecipientBtn.addEventListener('click', function() {
      addRecipientRow();
      updateRemoveButtons();
      updateRecipientCount();
    });
    
    // Remove recipient row handler (delegated)
    recipientsContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-recipient-btn') || 
          e.target.closest('.remove-recipient-btn')) {
        const row = e.target.closest('.recipient-row');
        row.remove();
        updateRemoveButtons();
        updateRecipientCount();
      }
    });
    
    // Form submission handler
    document.querySelector('form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Collect all recipient data
      collectRecipientData();
      
      // Validate that we have at least one recipient with email
      if (targets.length === 0) {
        alert('Please add at least one recipient with a valid email address.');
        return;
      }
      
      // Submit the form
      this.submit();
    });
    
    // Import CSV button handler
    importCSVBtn.addEventListener('click', function() {
      csvImportModal.show();
    });
    
    // Import CSV confirm button handler
    importCSVConfirmBtn.addEventListener('click', function() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a CSV file to import.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const csv = e.target.result;
        const lines = csv.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        
        // Check for required email column
        if (!headers.includes('email')) {
          alert('CSV must contain an "email" column.');
          return;
        }
        
        // Clear existing recipients
        recipientsContainer.innerHTML = '';
        
        // Add each row from CSV
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].trim() === '') continue;
          
          const values = lines[i].split(',').map(v => v.trim());
          const data = {};
          
          headers.forEach((header, index) => {
            if (index < values.length) {
              data[header] = values[index];
            }
          });
          
          // Skip if no email
          if (!data.email) continue;
          
          addRecipientRow(
            data.first_name || data.firstname || '',
            data.last_name || data.lastname || '',
            data.email,
            data.position || data.department || ''
          );
        }
        
        updateRemoveButtons();
        updateRecipientCount();
        csvImportModal.hide();
      };
      
      reader.readAsText(file);
    });
    
    // Helper functions
    function addRecipientRow(firstName = '', lastName = '', email = '', position = '') {
      const row = document.createElement('div');
      row.className = 'recipient-row mb-3 border-bottom pb-3';
      row.innerHTML = `
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label small">First Name</label>
            <input type="text" class="form-control recipient-first-name" placeholder="John" value="${firstName}">
          </div>
          <div class="col-md-4">
            <label class="form-label small">Last Name</label>
            <input type="text" class="form-control recipient-last-name" placeholder="Doe" value="${lastName}">
          </div>
          <div class="col-md-4">
            <label class="form-label small">Email (required)</label>
            <input type="email" class="form-control recipient-email" placeholder="john.doe@example.com" required value="${email}">
          </div>
          <div class="col-md-10 mt-2">
            <label class="form-label small">Position/Department</label>
            <input type="text" class="form-control recipient-position" placeholder="IT Manager" value="${position}">
          </div>
          <div class="col-md-2 mt-2 d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger remove-recipient-btn" style="width: 100%;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      recipientsContainer.appendChild(row);
    }
    
    function updateRemoveButtons() {
      const removeButtons = document.querySelectorAll('.remove-recipient-btn');
      const totalRows = removeButtons.length;
      
      removeButtons.forEach(btn => {
        btn.disabled = totalRows <= 1;
      });
    }
    
    function updateRecipientCount() {
      const count = document.querySelectorAll('.recipient-row').length;
      recipientCountEl.textContent = count;
      
      if (count === 0) {
        noRecipientsEl.style.display = 'block';
      } else {
        noRecipientsEl.style.display = 'none';
      }
    }
    
    function collectRecipientData() {
      targets = [];
      const rows = document.querySelectorAll('.recipient-row');
      
      rows.forEach(row => {
        const firstName = row.querySelector('.recipient-first-name').value.trim();
        const lastName = row.querySelector('.recipient-last-name').value.trim();
        const email = row.querySelector('.recipient-email').value.trim();
        const position = row.querySelector('.recipient-position').value.trim();
        
        if (email) {
          targets.push({
            first_name: firstName,
            last_name: lastName,
            email: email,
            position: position
          });
        }
      });
      
      updateTargetsInput();
    }
    
    function updateTargetsInput() {
      targetsInput.value = JSON.stringify(targets);
    }
  });
</script>
{% endblock %}