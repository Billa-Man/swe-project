{% extends "base.html" %}

{% block title %}Create Landing Page{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">{% if page_id %}Edit{% else %}Create{% endif %} Landing Page</h1>
            
            {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
            {% endif %}
            
            <div id="alert-container"></div>

            <form method="post" action="{% if page_id %}{% url 'page_detail' page_id %}{% else %}{% url 'page_list' %}{% endif %}" id="pageForm">
                {% csrf_token %}
                
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Landing Page Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                {% if page %}value="{{ page.name }}"{% endif %}>
                        </div>
                        
                        <div class="mb-3">
                            <label for="redirect_url" class="form-label">Redirect URL</label>
                            <input type="url" class="form-control" id="redirect_url" name="redirect_url" required
                                {% if page %}value="{{ page.redirect_url }}"{% endif %}>
                            <div class="form-text text-muted">Users will be redirected to this URL after landing page interaction</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="html" class="form-label">HTML Content</label>
                            <textarea class="form-control" id="html" name="html" rows="10" required>{% if page %}{{ page.html }}{% endif %}</textarea>
                            <div class="form-text text-muted">HTML content for your landing page</div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="capture_credentials" name="capture_credentials"
                                {% if page and page.capture_credentials %}checked{% endif %}>
                            <label class="form-check-label" for="capture_credentials">Capture Credentials</label>
                            <div class="form-text text-muted">Enable to capture user credentials submitted on this page</div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="capture_passwords" name="capture_passwords"
                                {% if page and page.capture_passwords %}checked{% endif %}>
                            <label class="form-check-label" for="capture_passwords">Capture Passwords</label>
                            <div class="form-text text-muted">Enable to capture passwords submitted on this page</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'control_center' %}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        {% if page_id %}Update{% else %}Create{% endif %} Landing Page
                    </button>
                </div>
            </form>
            
            {% if page_id %}
            <div class="mt-4">
                <form id="delete-form" method="post" onsubmit="return confirm('Are you sure you want to delete this landing page?');">
                    {% csrf_token %}
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">Delete Landing Page</button>
                </form>
            </div>
            <script>
                document.getElementById('delete-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (confirm('Are you sure you want to delete this landing page?')) {
                        var xhr = new XMLHttpRequest();
                        xhr.open('DELETE', '{% url "page_detail" page_id %}', true);
                        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                window.location.href = '{% url "control_center" %}';
                            } else {
                                alert('Error deleting landing page: ' + JSON.parse(xhr.responseText).error);
                            }
                        };
                        xhr.send();
                    }
                });
            </script>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    
    // Handle form submission
    const form = document.getElementById('pageForm');
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(form);
      const alertContainer = document.getElementById('alert-container');
      
      // Clear any existing alerts
      alertContainer.innerHTML = '';
      
      // Show loading state
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.innerHTML;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Creating...';
      submitButton.disabled = true;
      
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
          alertContainer.innerHTML = `
            <div class="alert alert-success mb-4">
              <i class="fas fa-check-circle me-2"></i> ${data.message}
            </div>
          `;
          
          // Redirect after a short delay
          setTimeout(function() {
            window.location.href = "{% url 'control_center' %}";
          }, 1000);
        } else {
          // Show error message
          alertContainer.innerHTML = `
            <div class="alert alert-danger mb-4">
              <i class="fas fa-exclamation-circle me-2"></i> ${data.error}
            </div>
          `;
          submitButton.innerHTML = originalButtonText;
          submitButton.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alertContainer.innerHTML = `
          <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-circle me-2"></i> An error occurred. Please try again.
          </div>
        `;
        submitButton.innerHTML = originalButtonText;
        submitButton.disabled = false;
      });
    });
  });
</script>
{% endblock %}