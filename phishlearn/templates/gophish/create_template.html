{% extends "base.html" %}
{% csrf_token %}
{% block title %}Create New Template{% endblock %}

{% block content %}
<div class="container">
  <div class="page-header">
    <h1 class="page-title">Create New Phishing Template</h1>
    <p class="page-description">Create a new email template for your phishing campaigns.</p>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-4">
      {% if error %}
        <div class="alert alert-danger mb-4">
          <i class="fas fa-exclamation-circle me-2"></i> {{ error }}
        </div>
      {% endif %}
      
      <div id="alert-container"></div>
      
      <form method="POST" action="{% url 'template_list' %}" id="templateForm">
        {% csrf_token %}
        
        <div class="mb-3">
          <label for="name" class="form-label">Template Name</label>
          <input type="text" class="form-control" id="name" name="name" required>
          <div class="form-text">A descriptive name for this template.</div>
        </div>
        
        <div class="mb-3">
          <label for="subject" class="form-label">Email Subject</label>
          <input type="text" class="form-control" id="subject" name="subject" required>
          <div class="form-text">The subject line that will appear in the email.</div>
        </div>
        
        <div class="mb-3">
          <label for="text" class="form-label">Plain Text Content</label>
          <textarea class="form-control" id="text" name="text" rows="5" required></textarea>
          <div class="form-text">Plain text version of the email for clients that don't support HTML.</div>
        </div>
        
        <div class="mb-3">
          <label for="html" class="form-label">HTML Content</label>
          <textarea class="form-control" id="html" name="html" rows="10" required></textarea>
          <div class="form-text">HTML version of the email. You can use HTML tags to format the email.</div>
        </div>
        
        <div class="mb-3">
          <label for="attachments" class="form-label">Attachments (JSON)</label>
          <textarea class="form-control" id="attachments" name="attachments" rows="3">[]</textarea>
          <div class="form-text">Attachments in JSON format. Advanced usage only.</div>
        </div>
        
        <div class="d-flex justify-content-between">
          <a href="{% url 'control_center' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Create Template
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Simple validation for the JSON field
    document.getElementById('attachments').addEventListener('change', function(e) {
      try {
        JSON.parse(e.target.value);
        e.target.classList.remove('is-invalid');
      } catch (error) {
        e.target.classList.add('is-invalid');
        alert('Invalid JSON format in attachments field');
      }
    });
    
    // Handle form submission
    const form = document.getElementById('templateForm');
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(form);
      const alertContainer = document.getElementById('alert-container');
      
      // Clear any existing alerts
      alertContainer.innerHTML = '';
      
      // Show loading state
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.innerHTML;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Creating...';
      submitButton.disabled = true;
      
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
          alertContainer.innerHTML = `
            <div class="alert alert-success mb-4">
              <i class="fas fa-check-circle me-2"></i> ${data.message}
            </div>
          `;
          
          // Redirect after a short delay
          setTimeout(function() {
            window.location.href = "{% url 'control_center' %}";
          }, 1000);
        } else {
          // Show error message
          alertContainer.innerHTML = `
            <div class="alert alert-danger mb-4">
              <i class="fas fa-exclamation-circle me-2"></i> ${data.error}
            </div>
          `;
          submitButton.innerHTML = originalButtonText;
          submitButton.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alertContainer.innerHTML = `
          <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-circle me-2"></i> An error occurred. Please try again.
          </div>
        `;
        submitButton.innerHTML = originalButtonText;
        submitButton.disabled = false;
      });
    });
  });
</script>
{% endblock %}