{% extends "base.html" %}

{% block title %}GoPhish Management{% endblock %}

{% block content %}
<div class="container">
  <div class="page-header mb-4">
    <h1 class="page-title">GoPhish Management</h1>
    <p class="page-description">Manage your phishing templates, users, and groups from this dashboard.</p>
  </div>

  <div class="row">
    <!-- Templates Section - First Column -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center bg-white py-3">
          <h2 class="h4 mb-0">Phishing Templates</h2>
          <a href="{% url 'create_template' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-1"></i> New
          </a>
        </div>
        <div class="card-body overflow-auto" style="max-height: 600px;">
          {% if templates %}
            <div class="list-group list-group-flush">
              {% for template in templates %}
                <div class="list-group-item list-group-item-action py-3 px-2">
                  <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{ template.name }}</h5>
                    <div class="btn-group" role="group">
                      <a href="{% url 'get_template_by_id' template.id %}" class="btn btn-sm btn-outline-primary" title="View">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{% url 'modify_template' template.id %}" class="btn btn-sm btn-outline-secondary" title="Edit">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger" title="Delete" 
                              data-bs-toggle="modal" data-bs-target="#deleteTemplateModal" 
                              data-id="{{ template.id }}" data-name="{{ template.name }}">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <p class="mb-1 text-muted small">Subject: {{ template.subject }}</p>
                  <small class="text-muted">Modified: {{ template.modified_date|date:"M d, Y" }}</small>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info mb-0">
              <i class="fas fa-info-circle me-2"></i> No templates found. Create your first template to get started.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Users Section - Second Column -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center bg-white py-3">
          <h2 class="h4 mb-0">GoPhish Users</h2>
          <a href="{% url 'create_user' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-1"></i> New
          </a>
        </div>
        <div class="card-body overflow-auto" style="max-height: 600px;">
          {% if users %}
            <div class="list-group list-group-flush">
              {% for user in users %}
                <div class="list-group-item list-group-item-action py-3 px-2">
                  <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{ user.username }}</h5>
                    <div class="btn-group" role="group">
                      <a href="{% url 'get_user_by_id' user.id %}" class="btn btn-sm btn-outline-primary" title="View">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{% url 'modify_user' user.id %}" class="btn btn-sm btn-outline-secondary" title="Edit">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger" title="Delete" 
                              data-bs-toggle="modal" data-bs-target="#deleteUserModal" 
                              data-id="{{ user.id }}" data-name="{{ user.username }}">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <span class="badge bg-primary">{{ user.role.name|default:"User" }}</span>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info mb-0">
              <i class="fas fa-info-circle me-2"></i> No users found. Create your first user to get started.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Groups Section - Third Column -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center bg-white py-3">
          <h2 class="h4 mb-0">Target Groups</h2>
          <a href="{% url 'create_group' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-1"></i> New
          </a>
        </div>
        <div class="card-body overflow-auto" style="max-height: 600px;">
          {% if groups %}
            <div class="list-group list-group-flush">
              {% for group in groups %}
                <div class="list-group-item list-group-item-action py-3 px-2">
                  <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{ group.name }}</h5>
                    <div class="btn-group" role="group">
                      <a href="{% url 'get_group_by_id' group.id %}" class="btn btn-sm btn-outline-primary" title="View">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{% url 'modify_group' group.id %}" class="btn btn-sm btn-outline-secondary" title="Edit">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger" title="Delete" 
                              data-bs-toggle="modal" data-bs-target="#deleteGroupModal" 
                              data-id="{{ group.id }}" data-name="{{ group.name }}">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <span class="badge bg-secondary">{{ group.targets|length }} target(s)</span>
                  <div><small class="text-muted">Modified: {{ group.modified_date|date:"M d, Y" }}</small></div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info mb-0">
              <i class="fas fa-info-circle me-2"></i> No groups found. Create your first group to get started.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Template Modal -->
<div class="modal fade" id="deleteTemplateModal" tabindex="-1" aria-labelledby="deleteTemplateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTemplateModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete template "<span id="templateName"></span>"?</p>
        <p class="text-danger">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteTemplateForm" method="POST" action="">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteUserModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete user "<span id="userName"></span>"?</p>
        <p class="text-danger">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteUserForm" method="POST" action="">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Group Modal -->
<div class="modal fade" id="deleteGroupModal" tabindex="-1" aria-labelledby="deleteGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteGroupModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete group "<span id="groupName"></span>"?</p>
        <p class="text-danger">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteGroupForm" method="POST" action="">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Template modal setup
    const deleteTemplateModal = document.getElementById('deleteTemplateModal');
    if (deleteTemplateModal) {
      deleteTemplateModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        
        deleteTemplateModal.querySelector('#templateName').textContent = name;
        document.getElementById('deleteTemplateForm').action = `/templates/${id}/delete/`;
      });
    }
    
    // User modal setup
    const deleteUserModal = document.getElementById('deleteUserModal');
    if (deleteUserModal) {
      deleteUserModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        
        deleteUserModal.querySelector('#userName').textContent = name;
        document.getElementById('deleteUserForm').action = `/users/${id}/delete/`;
      });
    }
    
    // Group modal setup
    const deleteGroupModal = document.getElementById('deleteGroupModal');
    if (deleteGroupModal) {
      deleteGroupModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        
        deleteGroupModal.querySelector('#groupName').textContent = name;
        document.getElementById('deleteGroupForm').action = `/groups/${id}/delete/`;
      });
    }
  });
</script>
{% endblock %}